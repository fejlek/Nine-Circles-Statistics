---
title: "The Fifth Circle: Survival Analysis, Part One"
author: "Jiří Fejlek"
date: "2025-09-01"
output:
  md_document:
    variant: GFM
code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

<br/>
This project is concerned with the analysis of survival data. Survival analysis involves the investigation of the expected duration of time until an event occurs, such as mechanical failure or recurrence of the disease. One quite peculiar problem encountered in survival analysis is censoring. Censoring occurs when some individuals do not experience the event during the observation period; thus, censoring is a form of missing data and is present in almost all studies.

In this project, we will go through all the fundamentals of survival analysis, namely the Kaplan-Meier estimator, the Cox proportional hazards model, and the accelerated failure time models. We will use the data from [1], a study concerned with investigating, among other things, the biomarker CXCL17 in the context of predicting the overall survival and the recurrence-free survival of post-surgery hepatocellular carcinoma (HCC) patients. 

We will somewhat repeat the analysis of the data presented in the paper. However, we will also perform some additional steps, such as fitting other models rather than just a Cox proportional hazards model, and model validation steps that were not performed in the original paper. In addition, we will follow quite closely  a great introductory text to survival analysis, Applied Survival Analysis Using R by Dirk F. Moore [2], and in some sense, this project is a solution to Exercise 6.1.:

... (data [1], 'hepatocellular' in the *asaur* package) contains 17 clinical and biomarker measurements on 227 patients, as well as overall survival and time to recurrence, both recorded in months. There are three measures of CXCL17 activity, CXCL17T (intratumoral), CXCL17P (peritumoral), and CXCL17N (nontumoral). There is a particular interest in whether they are related to overall and recurrence-free survival. Which of the three is most strongly related
to each survival outcome? ...
<br/>

## Hepatocellular dataset

<br/>
The Hepatocellular dataset contains the following information about 227 individuals who had
undergone curative resection for HCC between 2007 and 2010 at the Sun Yat-sen University Cancer Center [1].
<br/>

* **Age**
* **Gender** 
* **HBsAg** - hepatitis B surface antigen (negative/positive)
* **Cirrhosis** - (absent/present)
* **ALT** - alanine aminotransferase (U/liter, <=42/>42)
* **AST** - aspartate aminotransferase (U/liter, <=42/>42)
* **AFP** - alpha-fetoprotein (ng/ml <=25/>25)
* **Tumor size** - (cm <=5/>5) 
* **Tumor differentiation** - Edmondson grading system (I–II/III–IV)
* **Vascular invasion** - (absent/present)
* **Tumor multiplicity** - (solitary/multiple)
* **Capsulation** - (absent/present)
* **TNM stage** - International Union Against Cancer tumor-nodes-metastasis classification (I–II/III–IV)
* **BCLC stage** -  Barcelona Clinic Liver Cancer classification (0–A/B–C)
* **OS** - overall survival (interval between the dates of surgery and the date of death or the last follow-up, in months)
* **Death** - (no/yes)
* **RFS** - recurrence-free survival  (interval between the dates of surgery and recurrence or the last follow-up if no recurrence was observed in months)
* **Recurrence** - (no/yes)
* **CXCL17T** - intratumoral CXCL17 (density per megapixel)
* **CXCL17P** - peritumoral CXCL17 (density per megapixel)
* **CXCL17N** - nontumoral CXCL17 (density per megapixel)

<br/>
As usual, we start with loading the data and specifying the correct variable types.
<br/>

```{r, message=FALSE}
library(readr)
hepatoCellular <- read_csv('C:/Users/elini/Desktop/nine circles/hepatoCellular.csv')[,2:22]
head(hepatoCellular)

hepatoCellular$Gender <- factor(hepatoCellular$Gender)
levels(hepatoCellular$Gender) <- c('female','male')

hepatoCellular$HBsAg <- factor(hepatoCellular$HBsAg)
levels(hepatoCellular$HBsAg) <- c('negative','positive')

hepatoCellular$Cirrhosis <- factor(hepatoCellular$Cirrhosis)
levels(hepatoCellular$Cirrhosis) <- c('absent','present')

hepatoCellular$ALT <- factor(hepatoCellular$ALT)
levels(hepatoCellular$ALT) <- c('<42','>42')

hepatoCellular$AST <- factor(hepatoCellular$AST)
levels(hepatoCellular$AST) <- c('<42','>42')

hepatoCellular$AFP <- factor(hepatoCellular$AFP)
levels(hepatoCellular$AFP) <- c('<25','>=25')

hepatoCellular$Tumorsize <- factor(hepatoCellular$Tumorsize)
levels(hepatoCellular$Tumorsize ) <- c('<5','>5')

hepatoCellular$Tumordifferentiation <- factor(hepatoCellular$Tumordifferentiation)
levels(hepatoCellular$Tumordifferentiation ) <- c('I-II','III-IV')

hepatoCellular$Vascularinvasion <- factor(hepatoCellular$Vascularinvasion)
levels(hepatoCellular$Vascularinvasion ) <- c('absent','present')

hepatoCellular$Tumormultiplicity <- factor(hepatoCellular$Tumormultiplicity)
levels(hepatoCellular$Tumormultiplicity ) <- c('solitary','multiple')

hepatoCellular$Capsulation <- factor(hepatoCellular$Capsulation)
levels(hepatoCellular$Capsulation) <- c('absent','present')

hepatoCellular$TNM <- factor(hepatoCellular$TNM)
levels(hepatoCellular$TNM) <- c('I-II','III-IV')

hepatoCellular$BCLC <- factor(hepatoCellular$BCLC)
levels(hepatoCellular$BCLC) <- c('0-A','B-C')

hepatoCellular$Death <- factor(hepatoCellular$Death)
levels(hepatoCellular$Death) <- c('no','yes')

hepatoCellular$Recurrence <- factor(hepatoCellular$Recurrence)
levels(hepatoCellular$Recurrence) <- c('no','yes')
```

<br/>
Another important step is to check whether some data is missing. 
<br/>

```{r}
any(duplicated(hepatoCellular))
any(is.na(hepatoCellular))
```

<br/>
Next, let us plot the value of predictors to detect some potential problems with their values. 
<br/>

```{r,message=FALSE,warning=FALSE,echo=FALSE}
hist(hepatoCellular$Age,xlab = 'Age',main = '')
plot(hepatoCellular$Gender, main = 'Gender')
plot(hepatoCellular$HBsAg, main = 'HBsAg')
plot(hepatoCellular$Cirrhosis, main = 'Cirrhosis')
plot(hepatoCellular$ALT, main = 'ALT')
plot(hepatoCellular$AST, main = 'AST')
plot(hepatoCellular$AFP, main = 'AFP')
plot(hepatoCellular$Tumorsize, main = 'Tumorsize')
plot(hepatoCellular$Tumordifferentiation, main = 'Tumordifferentiation')
plot(hepatoCellular$Vascularinvasion, main = 'Vascularinvasion')
plot(hepatoCellular$Tumormultiplicity, main = 'Tumormultiplicity')
plot(hepatoCellular$TNM, main = 'TNM')
plot(hepatoCellular$BCLC, main = 'BCLC')
plot(hepatoCellular$Death, main = 'Death')
plot(hepatoCellular$Recurrence, main = 'Recurrence')
hist(hepatoCellular$CXCL17T,xlab = 'CXCL17T',main = '')
hist(hepatoCellular$CXCL17P,xlab = 'CXCL17P',main = '')
hist(hepatoCellular$CXCL17N,xlab = 'CXCL17N',main = '')
```

<br/>
Nothing seems out of the ordinary. We can notice that for some categories, namely **Gender**and **HBsAg**, there is one value that is quite underrepresented, which will make the estimation of its effect difficult.

As our last universal step, we will perform a simple redundancy analysis to detect potential redundant predictors. 
<br/>

```{r,message=FALSE,warning=FALSE}
library(Hmisc)
redun(~.- Death - Recurrence - OS - RFS,data = hepatoCellular,nk = 4, r2 = 0.95)
```

<br/>
No predictors seem overly redundant, and hence, we will consider all of them for modelling. 
<br/>

## Survival and hazard function and their estimators

<br/>
Let us start our survival analysis by establishing some basic terms. In survival analysis, the variable under investigation is time to the first occurrence of some event $T$, in our case, the recurrence of HCC and death. Since the usual question is a probability that $T$ is greater than some threshold, survival analysis often uses the survival function (reliability function) $S(t) = P[T>t] = 1 - F(t)$ to characterize the distribution of $T$ instead of the cumulative distribution function $F$.

Another important characteristics of the distribution of $T$ used in survival analysis  is the hazard function $h(t) = \lim_{\Delta t \rightarrow 0} \frac{P[t\leq T<t+\Delta t \mid T\geq t]}{\Delta t} = \frac{f(t)}{S(t)}$. The hazard function (intensity function or the force of mortality) is the probability that the individual fails, i.e., experiences the event, in the next small time interval divided by the length of this interval. For example, provided that the distribution of $T$ is exponential ($S(t) = e^{-\lambda t}$), the hazard function is constant (its value is equal to $\lambda$). In practice, we can expect the hazard to evolve over time. For example, we can expect the hazard function to start quite high in our case (many complications tend to appear shortly after surgery) and then decrease over time. 


The Kaplan–Meier estimator is the most important estimator of the survival function from the data. We cannot use a standard empirical cumulative distribution function as an estimator due to *censoring*. Not all patients experienced the event, i.e., we have only partial information about their survival (we only know that they survived till the last follow-up). The Kaplan–Meier estimator accounts for the censoring and its form is $\hat{S}(t) = \prod_{t_i \leq t} (1-\frac{d_i}{n_i})$, where  $n_i$ is a number of subjects at risk at time $t_i$ and $d_i$ is a number of subjects that failed at time $t_i$. We should note that the key assumption of the Kaplan–Meier estimator is non-informative censoring, i.e,  the estimator assumes that the censoring is unrelated to the outcome.

Let us plot the Kaplan–Meier estimator of the survival function for the overall survival (**OS**) for the whole dataset via the *survival* package.
<br/>

```{r,message=FALSE,warning=FALSE}
library(survival)
library(ggsurvfit)

# recode event/censoring to the format used in the survival package
hepatoCellular$Death <- as.numeric(hepatoCellular$Death) - 1
hepatoCellular$Recurrence <- as.numeric(hepatoCellular$Recurrence) - 1

km_os <- survfit(Surv(OS, Death) ~ 1, data = hepatoCellular, conf.type ='log-log')
summary(km_os)

survfit2(Surv(OS,Death) ~ 1, data = hepatoCellular,conf.type ='log-log') %>% 
  ggsurvfit() +
  labs(
    x = "Months",
    y = "Overall survival probability"
  ) + add_confidence_interval()
```

<br/>
The parameter *conf.type* refers to the method of computation of the confidence interval for the Kaplan–Meier estimator. Since the survival probability inherently lies in [0,1], the confidence intervals are computed for log(-log($S$)) to ensure that the confidence intervals for $S$ lie in [0,1] [2].


The Nelson-Altschuler estimator is an alternative estimator that estimates the cumulative hazard function as  $\sum_{t_i \leq t} \frac{d_i}{n_i}$. we can then use the relation  $S(t) = e^{-H(t)}$ to estimate the survival function (Fleming-Harrington estimator). We can check that both methods yield almost identical results.
<br/>

```{r,message=FALSE,warning=FALSE}
fh_os <- survfit(Surv(OS, Death) ~ 1, data = hepatoCellular,conf.type ='log-log',type='fh')
surv_func <- cbind(summary(km_os)$time,summary(km_os)$surv,summary(fh_os)$surv)
colnames(surv_func) <- c('time','K-M','F-H')
surv_func
```

<br/>
Next, let us plot the Kaplan-Meier estimator for recurrence of HCC (**RFS**).
<br/>

```{r,message=FALSE,warning=FALSE}
km_rfs <- survfit(Surv(RFS, Recurrence) ~ 1, data = hepatoCellular, conf.type ='log-log')
summary(km_rfs)

survfit2(Surv(RFS,Recurrence) ~ 1, data = hepatoCellular, conf.type ='log-log') %>% 
  ggsurvfit() +
  labs(
    x = "Months",
    y = "Recurrence-free survival probability"
  ) + add_confidence_interval()
```

<br/>
When constructing the Kaplan-Meier estimator for the recurrence, there is an important fact to consider. If a patient would die before experiencing the recurrence of HCC (they could die due to another unrelated cause), they had to be censored since their recurrence survival time cannot be measured. However, this censoring influences the recurrence event (they are dead and thus HCC cannot obviously recur for them in the future). 

These types of censoring events are called *competing risks* and they violate the assumption of the Kaplan-Meier estimator (censoring is unrelated to the event of interest). Crucially, they cause a bias in the Kaplan-Meier estimator, namely, they cause an overestimation of the risk of the event. The issue is that the Kaplan-Meier estimator does not differentiate between censoring due to lack of follow-up (subject is still at risk in our case of recurrence) and censoring due to, in our case, death (subject is obviously no longer at risk of recurrence) [3]. 

Let us make sure that we are not dealing with competing risks in our case.
<br/>

```{r,message=FALSE,warning=FALSE}
any(hepatoCellular$Recurrence == 0 & hepatoCellular$Death == 1)
```

<br/>
No subject died before experiencing recurrence, i.e., we have no observed competing risks in the data. Thus, the Kaplan-Meier estimator for **RFS** is valid. 

Another important descriptive statistic of the survival data is the median survival time (the smallest t such that the survival function is less than or equal to 0.5).
<br/>

```{r,message=FALSE,warning=FALSE}
km_os
km_rfs
```

<br/>
The median does not exist for overall survival because the probability of overall survival never fell below 0.5. 

The median follow-up time is another useful descriptive statistic. A simple median of in our case **OS** or **RFS** could be quite small, provided that death/recurrence happens often early. Thus, we can compute instead a potential median follow-up time (i.e., how long follow-up time would be provided if the subjects did not fail). We compute it by switching the role of censoring and event [2]. 
<br/>


```{r,message=FALSE,warning=FALSE}
# simple
median(hepatoCellular$OS)
median(hepatoCellular$RFS)

# potential
survfit(Surv(OS,1-Death) ~ 1, data = hepatoCellular)
survfit(Surv(RFS,1-Recurrence) ~ 1, data = hepatoCellular)
```

<br/>
We see that the potential median follow-up time is 50 and 55 months, respectively, whereas the simple one is only 36 and 18 months.


The last estimator we will mention in this part of our analysis is the estimator of the hazard function.
Similarly to estimating a density function, we need some kind of smoothing to obtain a continuous estimator. As usual, the difficult part is to determine how much smoothing is needed. We plot several kernel estimators of the hazard function (**OS**) with various values of the smoothing parameter via the package *muhaz* and compare the resulting survival function with the Kaplan-Meier estimator.
<br/>

```{r,message=FALSE,warning=FALSE}
library(muhaz)

muhaz1 <- muhaz(hepatoCellular$OS, hepatoCellular$Death, max.time=80, bw.grid=1, bw.method="global", b.cor="none")
muhaz5 <- muhaz(hepatoCellular$OS, hepatoCellular$Death, max.time=80, bw.grid=5, bw.method="global", b.cor="none")
muhaz10 <- muhaz(hepatoCellular$OS, hepatoCellular$Death, max.time=80, bw.grid=10, bw.method="global", b.cor="none")
muhaz15 <- muhaz(hepatoCellular$OS, hepatoCellular$Death, max.time=80, bw.grid=15, bw.method="global", b.cor="none")

par(mfrow = c(1, 2))
plot(muhaz1)
plot(muhaz5)
plot(muhaz10)
plot(muhaz15)

# compare K-M with hazard

haz1 <- muhaz1$haz.est
times1 <- muhaz1$est.grid
surv1 <- exp(-cumsum(haz1[1:(length(haz1)-1)]*diff(times1)))

haz2 <- muhaz5$haz.est
times2 <- muhaz5$est.grid
surv2 <- exp(-cumsum(haz2[1:(length(haz2)-1)]*diff(times2)))

haz3 <- muhaz10$haz.est
times3 <- muhaz10$est.grid
surv3 <- exp(-cumsum(haz3[1:(length(haz3)-1)]*diff(times3)))

haz4 <- muhaz15$haz.est
times4 <- muhaz15$est.grid
surv4 <- exp(-cumsum(haz4[1:(length(haz4)-1)]*diff(times4)))


par(mfrow = c(1, 1))
plot(km_os, conf.int=T, xlab="Time in months", xlim=c(0,80), ylab="Survival probability")
lines(surv1 ~ times1[1:(length(times1) - 1)], col = 'red')
lines(surv2 ~ times2[1:(length(times2) - 1)], col = 'blue')
lines(surv3 ~ times3[1:(length(times3) - 1)], col = 'green')
lines(surv4 ~ times4[1:(length(times4) - 1)], col = 'purple')
```

<br/>
The value of smoothing about 10 (15 might be too much) is just about right. As expected, the hazard rate increases in the early months after surgery and then steadily decreases about one year after the surgery. Interestingly, there appears to be a slight 'bump' in the hazard rate after about three years, but that could be just an artifact in the data.
<br/>

## Univariate analysis via log-rank tests

<br/>
In this part of our analysis, we will demonstrate the univariate analysis of the survival data. First, we can plot the Kaplan-Meier estimators for various factor levels. 
<br/>

```{r,message=FALSE,warning=FALSE}

survfit2(Surv(OS,Death) ~ Age > median(Age), data = hepatoCellular, conf.type ='log-log') %>% 
  ggsurvfit() +
  labs(
    x = "Months",
    y = "Overall survival probability (Age)"
  ) + add_confidence_interval()

survfit2(Surv(OS,Death) ~ Gender, data = hepatoCellular, conf.type ='log-log') %>% 
  ggsurvfit() +
  labs(
    x = "Months",
    y = "Overall survival probability (Gender)"
  ) + add_confidence_interval()

survfit2(Surv(OS,Death) ~ AST, data = hepatoCellular, conf.type ='log-log') %>% 
  ggsurvfit() +
  labs(
    x = "Months",
    y = "Overall survival probability (AST)"
  ) + add_confidence_interval()

survfit2(Surv(OS,Death) ~ AFP, data = hepatoCellular, conf.type ='log-log') %>% 
  ggsurvfit() +
  labs(
    x = "Months",
    y = "Overall survival probability (AFP)"
  ) + add_confidence_interval()


survfit2(Surv(OS,Death) ~ Tumorsize, data = hepatoCellular, conf.type ='log-log') %>% 
  ggsurvfit() +
  labs(
    x = "Months",
    y = "Overall survival probability (Tumorsize)"
  ) + add_confidence_interval()


survfit2(Surv(OS,Death) ~ Tumordifferentiation, data = hepatoCellular, conf.type ='log-log') %>% 
  ggsurvfit() +
  labs(
    x = "Months",
    y = "Overall survival probability (Tumordiff.)"
  ) + add_confidence_interval()


survfit2(Surv(OS,Death) ~ Vascularinvasion, data = hepatoCellular, conf.type ='log-log') %>% 
  ggsurvfit() +
  labs(
    x = "Months",
    y = "Overall survival probability (Vascularinv.)"
  ) + add_confidence_interval()


survfit2(Surv(OS,Death) ~ Tumormultiplicity, data = hepatoCellular, conf.type ='log-log') %>% 
  ggsurvfit() +
  labs(
    x = "Months",
    y = "Overall survival probability (Tumormult.)"
  ) + add_confidence_interval()


survfit2(Surv(OS,Death) ~ TNM, data = hepatoCellular, conf.type ='log-log') %>% 
  ggsurvfit() +
  labs(
    x = "Months",
    y = "Overall survival probability (TNM)"
  ) + add_confidence_interval()

survfit2(Surv(OS,Death) ~ BCLC, data = hepatoCellular, conf.type ='log-log') %>% 
  ggsurvfit() +
  labs(
    x = "Months",
    y = "Overall survival probability (BCLC)"
  ) + add_confidence_interval()

survfit2(Surv(OS,Death) ~ CXCL17T > median(CXCL17T), data = hepatoCellular, conf.type ='log-log') %>% 
  ggsurvfit() +
  labs(
    x = "Months",
    y = "Overall survival probability"
  ) + add_confidence_interval()

survfit2(Surv(OS,Death) ~ CXCL17P > median(CXCL17P), data = hepatoCellular, conf.type ='log-log') %>% 
  ggsurvfit() +
  labs(
    x = "Months",
    y = "Overall survival probability"
  ) + add_confidence_interval()


survfit2(Surv(OS,Death) ~ CXCL17N > median(CXCL17N), data = hepatoCellular, conf.type ='log-log') %>% 
  ggsurvfit() +
  labs(
    x = "Months",
    y = "Overall survival probability"
  ) + add_confidence_interval()
```

<br/>
We observe that some factors, such as **Age** and **Gender**, seem to have little effect. However, others, such as **Tumorsize**,**Tumormultiplicity**, **TNM**, and **BCLC**, influence the survival probability noticeably. Crucially, the biomarker **CXCL17** may help to differentiate the high-risk patients based on these plots.

The log-rank test allows us to formalize the comparison of two survival distributions [2].
<br/>

```{r,message=FALSE,warning=FALSE}
survdiff(Surv(OS,Death) ~ Age > median(Age), data = hepatoCellular)
```


```{r,message=FALSE,warning=FALSE}
var_names <- c('Age(low vs high)','Gender','HBsAg','Cirrhosis','ALT','AST','AFP','Tumorsize','Tumordifferentiation','Vascularinvasion','Tumormultiplicity','Capsulation','TNM','BCLC','CXCL17T(low vs high)','CXCL17P(low vs high)','CXCL17N(low vs high)')

lr1 <- survdiff(Surv(OS,Death) ~ Age > median(Age), data = hepatoCellular)
lr2 <- survdiff(Surv(OS,Death) ~ Gender, data = hepatoCellular)
lr3 <- survdiff(Surv(OS,Death) ~ HBsAg, data = hepatoCellular)
lr4 <- survdiff(Surv(OS,Death) ~ Cirrhosis, data = hepatoCellular)
lr5 <- survdiff(Surv(OS,Death) ~ ALT, data = hepatoCellular)
lr6 <- survdiff(Surv(OS,Death) ~ AST, data = hepatoCellular)
lr7 <- survdiff(Surv(OS,Death) ~ AFP, data = hepatoCellular)
lr8 <- survdiff(Surv(OS,Death) ~ Tumorsize, data = hepatoCellular)
lr9 <- survdiff(Surv(OS,Death) ~ Tumordifferentiation, data = hepatoCellular)
lr10 <- survdiff(Surv(OS,Death) ~ Vascularinvasion, data = hepatoCellular)
lr11 <- survdiff(Surv(OS,Death) ~ Tumormultiplicity, data = hepatoCellular)
lr12 <- survdiff(Surv(OS,Death) ~ Capsulation, data = hepatoCellular)
lr13 <- survdiff(Surv(OS,Death) ~ TNM, data = hepatoCellular)
lr14 <- survdiff(Surv(OS,Death) ~ BCLC, data = hepatoCellular)
lr15 <- survdiff(Surv(OS,Death) ~ CXCL17T > median(CXCL17T), data = hepatoCellular)
lr16 <- survdiff(Surv(OS,Death) ~ CXCL17P > median(CXCL17P), data = hepatoCellular)
lr17 <- survdiff(Surv(OS,Death) ~ CXCL17N > median(CXCL17N), data = hepatoCellular)


lr_pvalues_os <- c(lr1$pvalue,lr2$pvalue,lr3$pvalue,lr4$pvalue,lr5$pvalue,lr6$pvalue,lr7$pvalue,lr8$pvalue,lr9$pvalue,lr10$pvalue,lr11$pvalue,lr12$pvalue,lr13$pvalue,lr14$pvalue,lr15$pvalue,lr16$pvalue,lr17$pvalue)
names(lr_pvalues_os) <- var_names
lr_pvalues_os
```

<br/>
Let us also compute the test for recurrence-free survival.
<br/>

```{r,message=FALSE,warning=FALSE}
lr1 <- survdiff(Surv(RFS,Recurrence) ~ Age > median(Age), data = hepatoCellular)
lr2 <- survdiff(Surv(RFS,Recurrence) ~ Gender, data = hepatoCellular)
lr3 <- survdiff(Surv(RFS,Recurrence) ~ HBsAg, data = hepatoCellular)
lr4 <- survdiff(Surv(RFS,Recurrence) ~ Cirrhosis, data = hepatoCellular)
lr5 <- survdiff(Surv(RFS,Recurrence) ~ ALT, data = hepatoCellular)
lr6 <- survdiff(Surv(RFS,Recurrence) ~ AST, data = hepatoCellular)
lr7 <- survdiff(Surv(RFS,Recurrence) ~ AFP, data = hepatoCellular)
lr8 <- survdiff(Surv(RFS,Recurrence) ~ Tumorsize, data = hepatoCellular)
lr9 <- survdiff(Surv(RFS,Recurrence) ~ Tumordifferentiation, data = hepatoCellular)
lr10 <- survdiff(Surv(RFS,Recurrence) ~ Vascularinvasion, data = hepatoCellular)
lr11 <- survdiff(Surv(RFS,Recurrence) ~ Tumormultiplicity, data = hepatoCellular)
lr12 <- survdiff(Surv(RFS,Recurrence) ~ Capsulation, data = hepatoCellular)
lr13 <- survdiff(Surv(RFS,Recurrence) ~ TNM, data = hepatoCellular)
lr14 <- survdiff(Surv(RFS,Recurrence) ~ BCLC, data = hepatoCellular)
lr15 <- survdiff(Surv(RFS,Recurrence) ~ CXCL17T > median(CXCL17T), data = hepatoCellular)
lr16 <- survdiff(Surv(RFS,Recurrence) ~ CXCL17P > median(CXCL17P), data = hepatoCellular)
lr17 <- survdiff(Surv(RFS,Recurrence) ~ CXCL17N > median(CXCL17N), data = hepatoCellular)

lr_pvalues_rfs <- c(lr1$pvalue,lr2$pvalue,lr3$pvalue,lr4$pvalue,lr5$pvalue,lr6$pvalue,lr7$pvalue,lr8$pvalue,lr9$pvalue,lr10$pvalue,lr11$pvalue,lr12$pvalue,lr13$pvalue,lr14$pvalue,lr15$pvalue,lr16$pvalue,lr17$pvalue)
names(lr_pvalues_rfs) <- var_names
lr_pvalues_rfs
```

<br/>
We observe that CXCL17T,CXCL17P, and CXCL17N are all significant. However, we are not adjusting for other covariates. To do so, a solution would be stratification, e.g.
<br/>

```{r,message=FALSE,warning=FALSE}
survfit2(Surv(RFS,Recurrence) ~ strata(BCLC) + (CXCL17N > median(CXCL17N)), data = hepatoCellular, conf.type ='log-log') %>% 
  ggsurvfit() +
  labs(
    x = "Months",
    y = "Recurrence free survival probability"
  ) + add_confidence_interval()

survdiff(Surv(RFS,Recurrence) ~ strata(BCLC) + (CXCL17N > median(CXCL17N)), data = hepatoCellular)
```

<br/>
However, this approach does not handle continuous covariates very well. Moreover, while the log-rank test appears to be nonparametric, it is actually not, and it is mostly equivalent to the Cox proportional hazards model (https://www.fharrell.com/post/logrank), which we will discuss next.  
<br/>

## Cox proportional hazards model

<br/>
The Cox proportional hazards model assumes the hazard function $h(t) = h_0(t)e^{X\beta}$. It is often called a semi-parametric model, since the baseline hazard $h_0(t)$ actually does not need to be estimated to estimate parameters $\beta$. The model is actually quite similar to the continuation ratio model for ordinal response (Third Circle). The difference is that instead of ordered categories, we have continuous time. 

Having noticed that the proportional hazards assumption should be quite familiar, it essentially assumes that the effect of predictors on the hazard function does not change in time. Again, quite similar to the ordinal models, when proportionality means that the effect of predictors in the model did not change with the categories of the response. 

Before we proceed to fit the model, let us assess what kind of model our data supports. The effective sample size of the survival data is the number of failures [4], which is 97 (for **OS**)  and  143 (for **RFS**).
<br/> 

```{r,message=FALSE,warning=FALSE}
sum(hepatoCellular$Death)
sum(hepatoCellular$Recurrence)
```

<br/>
Thus, our data support about 5 - 10  and  7 - 14 predictors. We will include all predictors in our model (which stretches our guidelines, but we are mostly interested in testing the effect of **CXCL17** and thus parsimony is not as important). However, we cannot really include any interactions and nonlinear terms.
<br/>

### Parameter estimates and baseline hazard functions

<br/>
Let us fit the Cox proportional hazards model for **OS** first.
<br/>

```{r,message=FALSE,warning=FALSE}
library(car)

coxmodel_os <- coxph(Surv(OS, Death) ~ Age + Gender + HBsAg + Cirrhosis + ALT + AST + AFP + Tumorsize + Tumordifferentiation + Vascularinvasion + Tumormultiplicity  + Capsulation  + TNM  + BCLC  + CXCL17T  + CXCL17P  + CXCL17N, data = hepatoCellular, x = TRUE)

coefficients(coxmodel_os)

# no interactions -> we can use type II Anova
Anova(coxmodel_os)
```

<br/>
We observe that after adjusting for other covariates, only  **CXCL17P** is clearly significant, **CXCL17T** and **CXCL17N** are not (**CXCL17T** is somewhat borderline). 
<br/>

```{r,message=FALSE,warning=FALSE}
coxmodel_rfs <- coxph(Surv(RFS, Recurrence) ~ Age + Gender + HBsAg + Cirrhosis + ALT + AST + AFP + Tumorsize + Tumordifferentiation + Vascularinvasion + Tumormultiplicity  + Capsulation  + TNM  + BCLC  + CXCL17T  + CXCL17P  + CXCL17N, data = hepatoCellular, x = TRUE)

coefficients(coxmodel_rfs)
Anova(coxmodel_rfs)
```

<br/>
In the **RFS** model, both  **CXCL17T** and **CXCL17P** are significant.

Even though it is not strictly necessary to estimate the parameters in the model (and estimate the hazard ratios), we can also estimate the baseline hazard functions (and thus obtain absolute survival probabilities, not just ratios, if needed).
<br/>

```{r,message=FALSE,warning=FALSE}
par(mfrow = c(1, 1))

plot(basehaz(coxmodel_os,centered = FALSE)[,2],basehaz(coxmodel_os,centered = FALSE)[,1],xlab = 'Time (in months)', ylab = 'Baseline hazard function (OS)')
plot(basehaz(coxmodel_rfs,centered = FALSE)[,2],basehaz(coxmodel_rfs,centered = FALSE)[,1],xlab = 'Time (in months)', ylab = 'Baseline hazard function (RFS)')
```

<br/>
Let us end this section by plotting risk scores ($e^{X\beta}$) for predictors that appeared significant. 
<br/>

```{r,message=FALSE,warning=FALSE}
library(sjPlot)
plot_model(coxmodel_os, type = "pred", terms = c('AFP'),title = 'Predicted risk scores (OS)')
plot_model(coxmodel_os, type = "pred", terms = c('Tumorsize'),title = 'Predicted risk scores (OS)')
plot_model(coxmodel_os, type = "pred", terms = c('CXCL17P'),title = 'Predicted risk scores (OS)')


plot_model(coxmodel_rfs, type = "pred", terms = c('AFP'),title = 'Predicted risk scores (RFS)')
plot_model(coxmodel_rfs, type = "pred", terms = c('Tumorsize'),title = 'Predicted risk scores (RFS)')
plot_model(coxmodel_rfs, type = "pred", terms = c('BCLC'),title = 'Predicted risk scores (RFS)')
plot_model(coxmodel_rfs, type = "pred", terms = c('CXCL17T'),title = 'Predicted risk scores (RFS)')
plot_model(coxmodel_rfs, type = "pred", terms = c('CXCL17P'),title = 'Predicted risk scores (RFS)')
```

### Model diagnostics

<br/>
As always, we need to check the model specification/assumptions. One element specific to the Cox model is the proportional hazards assumption. This assumption can be investigated via the Schoenfeld residuals. Therneau and Grambsch showed that their expected value at time $t$ is approximately  $\beta(t) - \hat{\beta}$, where $\hat{\beta}$ is estimated from the Cox model and $\beta(t)$ are the actual time-dependent coefficients. These plots can be obtained by the function *cox.zph*.
<br/>

```{r,message=FALSE,warning=FALSE}
par(mfrow = c(1, 2))
plot(cox.zph(coxmodel_os))
plot(cox.zph(coxmodel_rfs))
```

<br/>
Provided that the proportional hazards assumption holds, these values are expected to be constant in time. A formal test consists of simply fitting horizontal lines in these plots.
<br/>

```{r,message=FALSE,warning=FALSE}
cox.zph(coxmodel_os)
cox.zph(coxmodel_rfs)
```

<br/>
We observe that the proportional hazards assumption is probably violated. Namely, **BCLC** is a clear suspect. One easy fix for cases in which the variable is of no particular interest to us and is categorical is stratification.
<br/>

```{r,message=FALSE,warning=FALSE}
coxmodel_os_strat <- coxph(Surv(OS, Death) ~ Age + Gender + HBsAg + Cirrhosis + ALT + AST + AFP + Tumorsize + Tumordifferentiation + Vascularinvasion + Tumormultiplicity  + Capsulation  + TNM  + strata(BCLC)  + CXCL17T  + CXCL17P  + CXCL17N, data = hepatoCellular, x =  TRUE)

coxmodel_rfs_strat <- coxph(Surv(RFS, Recurrence) ~ Age + Gender + HBsAg + Cirrhosis + ALT + AST + AFP + Tumorsize + Tumordifferentiation + Vascularinvasion + Tumormultiplicity  + Capsulation  + TNM  + strata(BCLC)  + CXCL17T  + CXCL17P  + CXCL17N, data = hepatoCellular, x = TRUE)

cox.zph(coxmodel_os_strat)
cox.zph(coxmodel_rfs_strat)
```

<br/>
By stratifying **BCL**, the proportionality test is no longer significant. Let us have a look at the coefficients of these new models.
<br/>

```{r,message=FALSE,warning=FALSE}
# for stratified Cox models, LR tests are not supported (we will use Wald tests instead)
(summary(coxmodel_os_strat)$coefficients)[14:16,]
(summary(coxmodel_rfs_strat)$coefficients)[14:16,]
```


<br/>
We observe that our results did not change much. An alternative to stratification would be to use 
time-varying coefficients instead (see https://cran.r-project.org/web/packages/survival/vignettes/timedep.pdf for more details). Let us take another look at the **BCLC** coefficient for the **OS** model, which appeared to be the most significant.
<br/>

```{r,message=FALSE,warning=FALSE}
par(mfrow = c(1, 1))
plot(cox.zph(coxmodel_os)[14])
```

<br/>
We can split the dataset by time and fit the model in which **OS** interacts with the split. 
<br/>

```{r,message=FALSE,warning=FALSE}

# split the dataset: t<15, 15<t<30, t > 30
hepatoCellular_split_os <- survSplit(Surv(OS, Death) ~ Age + Gender + HBsAg + Cirrhosis + ALT + AST + AFP + Tumorsize + Tumordifferentiation + Vascularinvasion + Tumormultiplicity  + Capsulation  + TNM  + BCLC  + CXCL17T  + CXCL17P  + CXCL17N, data= hepatoCellular, cut=c(15,30), episode= 'tgroup', id='id')

# fit Cox model, BCLC interacts with tgroup (variable denoting the intervals)
coxmodel_os_split <- coxph(Surv(tstart,OS,Death) ~ Age + Gender + HBsAg + Cirrhosis + ALT + AST + AFP + Tumorsize + Tumordifferentiation + Vascularinvasion + Tumormultiplicity  + Capsulation  + TNM  + BCLC:strata(tgroup)  + CXCL17T  + CXCL17P  + CXCL17N, data = hepatoCellular_split_os)


coefficients(coxmodel_os_split)[c(17,19,21)]
cox.zph(coxmodel_os_split)
```

<br/>
It appears that **BCLC** has its greatest effect early on and then dissipates. The non-proportionality after this modification is again no longer significant overall. However, this is not a systematic approach: we used the data informally to determine the time cut-offs. Thus, we will consider the stratified models for further diagnostics. 

Residuals that deserve some look are the martingale residuals [5].
<br/>

```{r,message=FALSE,warning=FALSE}
coxmodel_os_null <- coxph(Surv(OS, Death) ~ 1, data = hepatoCellular)
coxmodel_rfs_null <- coxph(Surv(RFS, Recurrence) ~ 1, data = hepatoCellular)

par(mfrow = c(1, 2))
plot(residuals(coxmodel_os_null, type='martingale'),ylab = 'Martingale residuals',main = 'Null model (OS)')
plot(residuals(coxmodel_os_strat, type='martingale'),ylab = 'Martingale residuals',main = 'Full model (OS)')

plot(residuals(coxmodel_rfs_null, type='martingale'),ylab = 'Martingale residuals',main = 'Null model (RFS)')
plot(residuals(coxmodel_rfs_strat, type='martingale'),ylab = 'Martingale residuals',main = 'Full model (RFS)')
```


<br/>
Large martingale residuals indicate a poor fit of the model for particular observations. For example, a large negative martingale residual indicates that the patient survived longer than expected, despite the model predicting high risks for them.

Another popular residuals are the dfbetas residuals (scaled by the variance of $\beta$), which measure the influence of each individual observation on the coefficients $\beta$.
<br/>


```{r,message=FALSE,warning=FALSE}
par(mfrow = c(1, 3))
plot(residuals(coxmodel_os_strat, type='dfbetas')[,14],ylab = 'dfbetas residuals',main = 'CXCL17T (OS)')
plot(residuals(coxmodel_os_strat, type='dfbetas')[,15],ylab = 'dfbetas residuals',main = 'CXCL17P (OS)')
plot(residuals(coxmodel_os_strat, type='dfbetas')[,16],ylab = 'dfbetas residuals',main = 'CXCL17N (OS)')

plot(residuals(coxmodel_rfs_strat, type='dfbetas')[,14],ylab = 'dfbetas residuals',main = 'CXCL17T (RFS)')
plot(residuals(coxmodel_rfs_strat, type='dfbetas')[,15],ylab = 'dfbetas residuals',main = 'CXCL17P (RFS)')
plot(residuals(coxmodel_rfs_strat, type='dfbetas')[,16],ylab = 'dfbetas residuals',main = 'CXCL17N (RFS)')
```

<br/>
One observation for the **OS** model seems very influential on the ** CXCL17T**.
<br/>

```{r,message=FALSE,warning=FALSE}
residuals(coxmodel_os_strat, type='dfbetas')[77,14]

coxmodel_os_strat_alt <- coxph(Surv(OS, Death) ~ Age + Gender + HBsAg + Cirrhosis + ALT + AST + AFP + Tumorsize + Tumordifferentiation + Vascularinvasion + Tumormultiplicity  + Capsulation  + TNM  + strata(BCLC)  + CXCL17T  + CXCL17P  + CXCL17N, data = hepatoCellular[-77,])

coefficients(coxmodel_os_strat)[14:16]
coefficients(coxmodel_os_strat_alt)[14:16]

summary(coxmodel_os_strat)$coefficients[14:16,]
summary(coxmodel_os_strat_alt)$coefficients[14:16,]
```

<br/>
Indeed, the coefficient for **CXCL17T** changed quite a lot and **CXCL17T** is now clearly significant (and **CXCL17P** is now borderline). 

Let us wrap this part up with a bootstrapped Wald test of the coefficients.
<br/>

```{r,message=FALSE,warning=FALSE}
set.seed(123) # for reproducibility
nb <- 2500

coefmat_os <- matrix(NA,nb,16)
coefmat_rfs <- matrix(NA,nb,16)

wald_boot_os <- matrix(0,16,nb)
pwald_os <- numeric(16)

wald_boot_rfs <- matrix(0,16,nb)
pwald_rfs <- numeric(16)

for(i in 1:nb){
  
  hepatoCellular_new <-  hepatoCellular[sample(nrow(hepatoCellular) , rep=TRUE),]
  
  model_os_new <- coxph(Surv(OS, Death) ~ Age + Gender + HBsAg + Cirrhosis + ALT + AST + AFP + Tumorsize + Tumordifferentiation + Vascularinvasion + Tumormultiplicity  + Capsulation  + TNM  + strata(BCLC)  + CXCL17T  + CXCL17P  + CXCL17N, data = hepatoCellular_new)
  
  model_rfs_new <- coxph(Surv(RFS, Recurrence) ~ Age + Gender + HBsAg + Cirrhosis + ALT + AST + AFP + Tumorsize + Tumordifferentiation + Vascularinvasion + Tumormultiplicity  + Capsulation  + TNM  + strata(BCLC)  + CXCL17T  + CXCL17P  + CXCL17N, data = hepatoCellular_new)
  
  coefmat_os[i,] <- coefficients(model_os_new)
  coefmat_rfs[i,] <- coefficients(model_rfs_new)
  
  for (j in 1:16){
    
  # trycatch to skip numerical problems with inversions
  V <- vcov(model_os_new)[j,j]
  wald_boot_os[j,i] <- tryCatch((coefficients(model_os_new)[j]-coefficients(coxmodel_os_strat)[j]) %*% solve(V) %*% (coefficients(model_os_new)[j]-coefficients(coxmodel_os_strat)[j]), error = function(e) {NaN})
  
  V <- vcov(model_rfs_new)[j,j]
  wald_boot_rfs[j,i] <- tryCatch((coefficients(model_rfs_new)[j]-coefficients(coxmodel_rfs_strat)[j]) %*% solve(V) %*% (coefficients(model_rfs_new)[j]-coefficients(coxmodel_rfs_strat)[j]), error = function(e) {NaN})
  
  }
}

for (j in 1:16){
V <- vcov(coxmodel_os_strat)[j,j]
wald <- coefficients(coxmodel_os_strat)[j] %*% solve(V) %*% coefficients(coxmodel_os_strat)[j]      
pwald_os[j] <- mean(wald_boot_os[j,] > as.numeric(wald),na.rm = TRUE) # p-value

V <- vcov(coxmodel_rfs_strat)[j,j]
wald <- coefficients(coxmodel_rfs_strat)[j] %*% solve(V) %*% coefficients(coxmodel_rfs_strat)[j]      
pwald_rfs[j] <- mean(wald_boot_rfs[j,] > as.numeric(wald),na.rm = TRUE) # p-value

}

var_names <- c('Age','Gender','HBsAg','Cirrhosis','ALT','AST','AFP','Tumorsize','Tumordifferentiation','Vascularinvasion','Tumormultiplicity','Capsulation','TNM','CXCL17T','CXCL17P','CXCL17N')
names(pwald_os) <- var_names
names(pwald_rfs) <- var_names

pwald_os[14:16]
pwald_rfs[14:16]
```

<br/>
The bootstrap aligns with our original assessments; **CXCL17P** is significant in the **OS** model, and **CXCL17T** and **CXCL17P** are significant in the **RFS** model. We can also compute bootstrap confidence intervals (quantile-based).          
<br/>

```{r,message=FALSE,warning=FALSE}
ci_os <- cbind(confint(coxmodel_os_strat),t(apply(coefmat_os,2,function(x) quantile(x,c(0.025,0.975)))))[c(14,15,16),]
colnames(ci_os) <- c('2.5 %','97.5 %','2.5 % (boot)','97.5 % (boot)')


ci_rfs <- cbind(confint(coxmodel_rfs_strat),t(apply(coefmat_rfs,2,function(x) quantile(x,c(0.025,0.975)))))[c(14,15,16),]
colnames(ci_rfs) <- c('2.5 %','97.5 %','2.5 % (boot)','97.5 % (boot)')

ci_os
ci_rfs
```

### Model validation

<br/>
Let us now focus on metrics associated with the Cox model, which we can use for its validation. The first metric concordance [6] helps assess the model's discrimination capability. Concordance is a proportion of concordance pairs among all comparable pairs. For survival data, a pair of data is comparable whenever they differ in failure time. A comparable pair is considered concordant if the observation with the higher risk score actually experienced the event. 
<br/>


```{r,message = FALSE,warning=FALSE}
concordance(coxmodel_os)$concordance
concordance(coxmodel_rfs)$concordance
concordance(coxmodel_os_strat)$concordance
concordance(coxmodel_rfs_strat)$concordance
```

<br/>
We should note here that concordance has its unique issues with survival data compared to, for example, binary response data. For the binary response, comparable pairs differ in outcome; for survival data, they differ in failure time. However, failure time is a continuous variable, and thus, these differences, and consequently, the underlying risks, can be quite small. In other words, concordance can compare quite a lot of very similar observations in terms of their risk scores. Hence, overall concordance for survival models can be surprisingly small even for decent models, because while these models can discriminate between distinct risk groups, they cannot discriminate within these groups, see [7] for a quite extreme example. 

To provide an example here, let us assume that we will compare only the pairs in which the ratio of failure times is at least 4.

```{r}
conc <- function(risk,failt,event) {
  
n_conc <- 0 
n_comp<- 0

n <- length(risk)

for(i in 1:n){
  
  risk_i <- risk[i]
  failt_i <- failt[i]
  event_i <- event[i]

  if ((i+1) < n){
  for(j in (i+1):n){
    
    risk_j <- risk[j]
    failt_j <- failt[j]
    event_j <- event[j]
    
      if ((failt_i < 0.25*failt_j | failt_j < 0.25*failt_i ) & ((failt_i < failt_j & event_i == 1) | (failt_i > failt_j & event_j == 1) )) {
        
        n_comp <- n_comp + 1
        
        
          if ((failt_i < failt_j & risk_i >  risk_j & event_i == 1) | (failt_i > failt_j & risk_i <  risk_j & event_j == 1  )) {
            n_conc <- n_conc + 1
            } else if (risk_i == risk_j) {}
          
            }
          }
      }
    }

return ((n_conc)/(n_comp))
}


conc(predict(coxmodel_os,type = 'risk'),hepatoCellular$OS,hepatoCellular$Death)
conc(predict(coxmodel_rfs,type = 'risk'),hepatoCellular$RFS,hepatoCellular$Recurrence)
```

<br/>
We observe that the concordance jumped by 0.1 for both **OS** and **RFS** when comparing only extreme pairs. When evaluating the survival models in terms of concordance, we must consider what type of discrimination is actually of interest to us. 

Another popular discrimination score that we encountered in the previous projects is the Brier score. For the uncensored survival data, the Brier score at time $t$ is simply $B(t) = \frac{1}{n}\sum_i (1_{T_i \leq t} - S_i(t))^2$, where $1_{T_i \leq t}$ is an indicator that observation $i$ have not experienced till time $t$ and $S_i(t)$ is the survival probability till time $t$. The actual Brier score for the survival data is a bit more complicated, since we have to deal with the censoring, for example, by weighting the values by the probability of censoring  (inverse probability of censoring weights method [8]), see, e.g., https://square.github.io/pysurvival/metrics/brier_score.html for the complete formula.

Since the Brier score is defined only for one particular time instant, it makes sense to integrate it over the whole time interval of interest. This integrated Brier score is actually the continuous version of the ranked probability score (RPS) for the ordinal response.

We will compute the integrated Brier score using the package *pec* (*cens.model = 'marginal'* denotes that distribution of the censoring events is estimated via the Kaplan-Meier estimator ).
<br/>

```{r,message = FALSE,warning=FALSE}
library(pec)
as.numeric(crps(pec(coxmodel_os,cens.model = 'marginal'),start = 0, times = 83))[2]
as.numeric(crps(pec(coxmodel_rfs,cens.model = 'marginal'),start = 0, times = 81))[2]
as.numeric(crps(pec(coxmodel_os_strat,cens.model = 'marginal'),start = 0, times = 79))[2]
as.numeric(crps(pec(coxmodel_rfs_strat,cens.model = 'marginal'),start = 0, times = 81))[2]
```

<br/>
To conclude this section, we will mention the assessment of the calibration of Cox models. We will use the method proposed in [9]. The method is based on the observation that the Cox regression with a prefixed baseline hazard reduces to the Poisson regression. First, we obtain the values of linear predictors and the logarithms of baseline hazards at the time of the last follow-up. Then, we fit a Poisson model with **Death / Recurrence** as the response and the linear predictor as the predicted variable and logarithms of baseline hazards as offsets. This approach is very similar to the calibration assessment of logistic models. 
<br/>

```{r,message = FALSE,warning=FALSE}
# OS model
p <- log(predict(coxmodel_os,type='expected')) # linear predictor + log base hazard 
lp <- predict(coxmodel_os, type='lp') # linear predictor 
logbase <- p - lp # log base hazard at T 
fit <- glm(Death ~ lp + offset(logbase), family=poisson,data=hepatoCellular)
coefficients(fit)

# RFS model
p <- log(predict(coxmodel_rfs,type='expected')) 
lp <- predict(coxmodel_rfs, type='lp') 
logbase <- p - lp 
fit <- glm(Recurrence ~ lp + offset(logbase), family=poisson,data=hepatoCellular)
coefficients(fit)

# OS model strat
p <- log(predict(coxmodel_os_strat,type='expected')) # linear predictor + log base hazard 
lp <- predict(coxmodel_os_strat, type='lp') # linear predictor 
logbase <- p - lp # log base hazard at T 
fit <- glm(Death ~ lp + offset(logbase), family=poisson,data=hepatoCellular)
coefficients(fit)

# RFS model strat
p <- log(predict(coxmodel_rfs_strat,type='expected')) 
lp <- predict(coxmodel_rfs_strat, type='lp') 
logbase <- p - lp 
fit <- glm(Recurrence ~ lp + offset(logbase), family=poisson,data=hepatoCellular)
coefficients(fit)
```

<br/>
Naturally, if we evaluate the calibration on the same set of data, we get a perfect calibration. However, this is not the case when we assess the calibration on the dataset that was not used for learning the model.
<br/>

```{r,message = FALSE,warning=FALSE}
library(caret)
set.seed(123)

d <- createFolds(seq(1,dim(hepatoCellular)[1],1), k = 10)
index <- unlist(d[1])
train_set <- hepatoCellular[-index,]
test_set <- hepatoCellular[index,]
    
model_os_new <- coxph(Surv(OS,Death) ~ Age + Gender + HBsAg + Cirrhosis + ALT + AST + AFP + Tumorsize + Tumordifferentiation + Vascularinvasion + Tumormultiplicity  + Capsulation  + TNM  + BCLC  + CXCL17T  + CXCL17P  + CXCL17N, data = train_set)
p <- log(predict(model_os_new,test_set,type='expected')) 
lp <- predict(model_os_new,test_set, type='lp')  
logbase <- p - lp # log base hazard at T 
fit <- glm(Death ~ lp + offset(logbase), family=poisson,data=test_set)
coefficients(fit)
```

<br/>
Let us use cross-validation to validate the performance of the Cox models. 
<br/>

```{r,message = FALSE,warning=FALSE}
## Number of repetitions and folds
rep <- 100
folds <- 10

set.seed(123) # for reproducibility

k <- 1

concordance_cv <- matrix(NA,folds*rep,4)
brier_cv <- matrix(NA,folds*rep,4)
gamma0_cv <- matrix(NA,folds*rep,4)
gamma1_cv <- matrix(NA,folds*rep,4)


for(j in 1:rep){
  
  d <- createFolds(seq(1,dim(hepatoCellular)[1],1), k = 10)
  
  for(i in 1:folds){

    index <- unlist(d[i])
    train_set <- hepatoCellular[-index,]
    test_set <- hepatoCellular[index,]

    model_os_new <- coxph(Surv(OS,Death) ~ Age + Gender + HBsAg + Cirrhosis + ALT + AST + AFP + Tumorsize + Tumordifferentiation + Vascularinvasion + Tumormultiplicity  + Capsulation  + TNM  + BCLC  + CXCL17T  + CXCL17P  + CXCL17N, data = train_set, x =  TRUE)

    model_rfs_new <- coxph(Surv(RFS,Recurrence) ~ Age + Gender + HBsAg + Cirrhosis + ALT + AST + AFP + Tumorsize + Tumordifferentiation + Vascularinvasion + Tumormultiplicity  + Capsulation  + TNM  + BCLC  + CXCL17T  + CXCL17P  + CXCL17N, data = train_set, x =  TRUE)
    
    model_os_strat_new <- coxph(Surv(OS,Death) ~ Age + Gender + HBsAg + Cirrhosis + ALT + AST + AFP + Tumorsize + Tumordifferentiation + Vascularinvasion + Tumormultiplicity  + Capsulation  + TNM  + strata(BCLC)  + CXCL17T  + CXCL17P  + CXCL17N, data = train_set, x =  TRUE)

    model_rfs_strat_new <- coxph(Surv(RFS,Recurrence) ~ Age + Gender + HBsAg + Cirrhosis + ALT + AST + AFP + Tumorsize + Tumordifferentiation + Vascularinvasion + Tumormultiplicity  + Capsulation  + TNM  + strata(BCLC)  + CXCL17T  + CXCL17P  + CXCL17N, data = train_set, x =  TRUE)
    

    # concordance
    concordance_cv[k,1] <- concordance(model_os_new,newdata = test_set)$concordance
    concordance_cv[k,2] <- concordance(model_rfs_new,newdata = test_set)$concordance
    concordance_cv[k,3] <- concordance(model_os_strat_new,newdata = test_set)$concordance
    concordance_cv[k,4] <- concordance(model_rfs_strat_new,newdata = test_set)$concordance
    
    # brier
    brier_cv[k,1] <- as.numeric(crps(pec(model_os_new,newdata = test_set,cens.model = 'marginal')))[2]
    brier_cv[k,2] <- as.numeric(crps(pec(model_rfs_new,newdata = test_set,cens.model = 'marginal')))[2]
    brier_cv[k,3] <- as.numeric(crps(pec(model_os_strat_new,newdata = test_set,cens.model = 'marginal'),start = min(test_set$OS), times = max(test_set$OS) - min(test_set$OS)))[2]
    brier_cv[k,4] <- as.numeric(crps(pec(model_rfs_strat_new,newdata = test_set,cens.model = 'marginal'),start = min(test_set$RFS), times = max(test_set$RFS)))[2]
    
    # calibration
    p_os <- log(predict(model_os_new,newdata = test_set,type='expected'))
    lp_os <- predict(model_os_new, newdata = test_set,type='lp')
    fit_os <- tryCatch(glm(Death ~ lp_os + offset(p_os-lp_os), family=poisson,data=test_set), error = function(e) {NA})
    
    p_rfs <- log(predict(model_rfs_new,newdata = test_set,type='expected'))
    lp_rfs <- predict(model_rfs_new, newdata = test_set,type='lp')
    fit_rfs <- tryCatch(glm(Recurrence ~ lp_rfs + offset(p_rfs-lp_rfs), family=poisson,data=test_set), error = function(e) {NA})
    
    p_os_strat <- log(predict(model_os_strat_new,newdata = test_set,type='expected'))
    lp_os_strat <- predict(model_os_new, newdata = test_set,type='lp')
    fit_os_strat <- tryCatch(glm(Death ~ lp_os_strat + offset(p_os_strat-lp_os_strat), family=poisson,data=test_set), error = function(e) {NA})
    
    p_rfs_strat <- log(predict(model_rfs_strat_new,newdata = test_set,type='expected'))
    lp_rfs_strat <- predict(model_rfs_new, newdata = test_set,type='lp')
    fit_rfs_strat <- tryCatch(glm(Recurrence ~ lp_rfs_strat + offset(p_rfs_strat-lp_rfs_strat), family=poisson,data=test_set), error = function(e) {NA})
    

    gamma0_cv[k,1] <- tryCatch(coefficients(fit_os)[1], error = function(e) {NA})
    gamma0_cv[k,2] <- tryCatch(coefficients(fit_rfs)[1], error = function(e) {NA})
    gamma0_cv[k,3] <- tryCatch(coefficients(fit_os_strat)[1], error = function(e) {NA})
    gamma0_cv[k,4] <- tryCatch(coefficients(fit_rfs_strat)[1], error = function(e) {NA})
    
    gamma1_cv[k,1] <- tryCatch(coefficients(fit_os)[2], error = function(e) {NA})
    gamma1_cv[k,2] <- tryCatch(coefficients(fit_rfs)[2], error = function(e) {NA})
    gamma1_cv[k,3] <- tryCatch(coefficients(fit_os_strat)[2], error = function(e) {NA})
    gamma1_cv[k,4] <- tryCatch(coefficients(fit_rfs_strat)[2], error = function(e) {NA})
    
    k <- k + 1
  }
}

cv_res <- rbind(apply(concordance_cv,2,mean,na.rm=TRUE),apply(brier_cv,2,mean, na.rm=TRUE),apply(gamma0_cv,2,mean,na.rm=TRUE),apply(gamma1_cv,2,mean,na.rm=TRUE))
colnames(cv_res) <- c('Cox (OS)', 'Cox (RFS)','Cox (OS) strat', 'Cox (RFS) strat')
rownames(cv_res) <- c('Concordance','Brier','Intercept','Slope')
cv_res
```

<br/>
We observe that all metrics decreased noticeably. For **OS**, the best model appears to be the stratified model. For **RFS**, the best model is the plain model. Still, the overall discrimination metrics are better than discrimination via a random chance. We should note that cross-validation for the stratified models is not fully valid, as our stratification was based on the data; thus, this step should also be incorporated into the cross-validation.
<br/>

## Parametric models

<br/>
The next type of models we will discuss in the project, as an alternative to the Cox proportional hazards model, are the fully parametric models. Namely, accelerated failure time models (AFT): $S(T \mid X) = \psi ((\mathrm{log}(T)-X\beta)/\sigma))$ or equivalently $\mathrm{log} T = X\beta + \sigma\varepsilon$, where $\sigma$ is a scale parameter and $\varepsilon$ has a distribution $\psi$. The distribution $\psi$ is usually assumed to be  normal  ($\psi(u) = 1 - \Phi (u)$), logistic $\psi(u) = (1 + e^u)^{-1}$, or extreme valued distribution ($\psi(u) = e^{-e^u}$). These choices lead to the log-normal, the log-logistic, and the Weibull AFT model, respectively. 

The Weibull model is a bit special in comparison to other AFT models in the sense that it is a parametric proportional hazards model since $S(T\mid X) = \mathrm{exp}[-\mathrm{exp}((\mathrm{log}T-X\beta)/\sigma)] = \mathrm{exp}[-H(T\mid X)]$, where $H(T\mid X) = \mathrm{exp}(\mathrm{log}T/\sigma - X\beta/\sigma) = \mathrm{exp}(\mathrm{log}T/\sigma + X\tilde{\beta})$, i.e., hazards stay proportional in time for various $X$. We should note that the Weibull model is the only model that is both an AFT model and a proportional hazards model.

The Weibull model is called like that because $S(T) = \mathrm{exp}(-\lambda^\alpha T^\alpha) = \mathrm{exp}(-\mathrm{exp}(\alpha\mathrm{log}\lambda +  \alpha\mathrm{log}T))$ is a survival function of the Weibull distribution (using more standard parametrization). Provided that $\sigma$ /  $\alpha$ is fixed at one, the Weibull regression model reduces to an exponential model, i.e., the baseline hazard is constant in time for all $X$.
<br/>

###  Fit of AFT models and checking assumptions

<br/>
Let us fit all the aforementioned AFT models.
<br/>

```{r,message = FALSE,warning=FALSE}
exp_reg_os <- survreg(Surv(OS, Death) ~ Age + Gender + HBsAg + Cirrhosis + ALT + AST + AFP + Tumorsize + Tumordifferentiation + Vascularinvasion + Tumormultiplicity  + Capsulation  + TNM  + BCLC  + CXCL17T  + CXCL17P  + CXCL17N, data = hepatoCellular,dist='exponential')

weib_reg_os <- survreg(Surv(OS, Death) ~ Age + Gender + HBsAg + Cirrhosis + ALT + AST + AFP + Tumorsize + Tumordifferentiation + Vascularinvasion + Tumormultiplicity  + Capsulation  + TNM  + BCLC  + CXCL17T  + CXCL17P  + CXCL17N, data = hepatoCellular,dist='weibull')

lnorm_reg_os <- survreg(Surv(OS, Death) ~ Age + Gender + HBsAg + Cirrhosis + ALT + AST + AFP + Tumorsize + Tumordifferentiation + Vascularinvasion + Tumormultiplicity  + Capsulation  + TNM  + BCLC  + CXCL17T  + CXCL17P  + CXCL17N, data = hepatoCellular,dist='lognormal')

llog_reg_os <- survreg(Surv(OS, Death) ~ Age + Gender + HBsAg + Cirrhosis + ALT + AST + AFP + Tumorsize + Tumordifferentiation + Vascularinvasion + Tumormultiplicity  + Capsulation  + TNM  + BCLC  + CXCL17T  + CXCL17P  + CXCL17N, data = hepatoCellular,dist='loglogistic')

exp_reg_rfs <- survreg(Surv(RFS, Recurrence) ~ Age + Gender + HBsAg + Cirrhosis + ALT + AST + AFP + Tumorsize + Tumordifferentiation + Vascularinvasion + Tumormultiplicity  + Capsulation  + TNM  + BCLC  + CXCL17T  + CXCL17P  + CXCL17N, data = hepatoCellular,dist='exponential')

weib_reg_rfs <- survreg(Surv(RFS, Recurrence) ~ Age + Gender + HBsAg + Cirrhosis + ALT + AST + AFP + Tumorsize + Tumordifferentiation + Vascularinvasion + Tumormultiplicity  + Capsulation  + TNM  + BCLC  + CXCL17T  + CXCL17P  + CXCL17N, data = hepatoCellular,dist='weibull')

lnorm_reg_rfs <- survreg(Surv(RFS, Recurrence) ~ Age + Gender + HBsAg + Cirrhosis + ALT + AST + AFP + Tumorsize + Tumordifferentiation + Vascularinvasion + Tumormultiplicity  + Capsulation  + TNM  + BCLC  + CXCL17T  + CXCL17P  + CXCL17N, data = hepatoCellular,dist='lognormal')

llog_reg_rfs <- survreg(Surv(RFS, Recurrence) ~ Age + Gender + HBsAg + Cirrhosis + ALT + AST + AFP + Tumorsize + Tumordifferentiation + Vascularinvasion + Tumormultiplicity  + Capsulation  + TNM  + BCLC  + CXCL17T  + CXCL17P  + CXCL17N, data = hepatoCellular,dist='loglogistic')
```

<br/>
We can compare the model using the Akaike information criterion.
<br/>

```{r,message = FALSE,warning=FALSE}
AIC(exp_reg_os)
AIC(weib_reg_os)
AIC(lnorm_reg_os)
AIC(llog_reg_os)

AIC(exp_reg_rfs)
AIC(weib_reg_rfs)
AIC(lnorm_reg_rfs)
AIC(llog_reg_rfs)
```
  
<br/>
The log-normal models (noticeably non-proportional hazards model) are the best fit. Let's test the significance of the predictors next.
<br/>

  
```{r,message = FALSE,warning=FALSE}  
pvalues_LR_os <- cbind(Anova(exp_reg_os)$`Pr(>Chisq)`,Anova(weib_reg_os)$`Pr(>Chisq)`,Anova(lnorm_reg_os)$`Pr(>Chisq)`,Anova(llog_reg_os)$`Pr(>Chisq)`)
rownames(pvalues_LR_os) <- names(coefficients(exp_reg_os)[2:length(coefficients(exp_reg_os))])
colnames(pvalues_LR_os) <- c('exp','weibull','lognorm','loglogist')
pvalues_LR_os

pvalues_LR_rfs <- cbind(Anova(exp_reg_rfs)$`Pr(>Chisq)`,Anova(weib_reg_rfs)$`Pr(>Chisq)`,Anova(lnorm_reg_rfs)$`Pr(>Chisq)`,Anova(llog_reg_rfs)$`Pr(>Chisq)`)
rownames(pvalues_LR_rfs) <- names(coefficients(exp_reg_rfs)[2:length(coefficients(exp_reg_rfs))])
colnames(pvalues_LR_rfs) <- c('exp','weibull','lognorm','loglogist')
pvalues_LR_rfs
```

<br/>
The results are quite close to each other and to the Cox model. Again, **CXCL17T** and **CXCL17P** biomarkers seem mostly significant.

Again, we need to check the assumptions of the model. We will focus on the lognormal models, since they have attained the lowest value of AIC. An approach mentioned in [4] and nicely presented in https://www.drizopoulos.com/courses/emc/basic_surivival_analysis_in_r#residuals is to plot the residuals $(\mathrm{log} T - X\beta)/\sigma$ against the assumed distribution. Since $\mathrm{log} T$ is censored, we will again employ the Kaplan-Meier estimator to get the estimate of the distribution of residuals. 
<br/>

```{r,message = FALSE,warning=FALSE}

rr <- (log(hepatoCellular$OS) - lnorm_reg_os$linear.predictors)/lnorm_reg_os$scale # residuals
resKM <- survfit(Surv(rr, Death) ~ 1, data = hepatoCellular) # KM of residuals
plot(resKM, mark.time = FALSE, xlab = "Residuals", ylab = "Overall Survival Probability")
xx <- seq(min(rr), max(rr), length.out = 50)
 yy <- pnorm(xx, lower.tail = FALSE) # for log-normal model
# yy <- plogis(xx, lower.tail = FALSE) # for log-logistic model 
# yy <- exp(- exp(xx)) # for weibull model
lines(xx, yy, col = "red", lwd = 2)

rr <- (log(hepatoCellular$RFS) - lnorm_reg_rfs$linear.predictors)/lnorm_reg_rfs$scale # residuals
resKM <- survfit(Surv(rr, Recurrence) ~ 1, data = hepatoCellular) # KM of residulas
plot(resKM, mark.time = FALSE, xlab = "Residuals", ylab = "Reccurence-free Survival Probability")
xx <- seq(min(rr), max(rr), length.out = 50)
 yy <- pnorm(xx, lower.tail = FALSE) # for log-normal model
# yy <- plogis(xx, lower.tail = FALSE) # for log-logistic model 
# yy <- exp(- exp(xx)) # for weibull model
 lines(xx, yy, col = "red", lwd = 2)
```

<br/>
It seems that the log-normal model is a pretty good fit. Before we continue, we will refit the models via the *rms* package, since it provides a better functionality for parametric survival models than the *survival* package.
<br/>

```{r,message = FALSE,warning=FALSE}
library(rms)

exp_reg_os_psm <- psm (Surv(OS, Death) ~ Age + Gender + HBsAg + Cirrhosis + ALT + AST + AFP + Tumorsize + Tumordifferentiation + Vascularinvasion + Tumormultiplicity  + Capsulation  + TNM  + BCLC  + CXCL17T  + CXCL17P  + CXCL17N, data = as.data.frame(hepatoCellular), dist= 'exponential' , y=TRUE)

weib_reg_os_psm <- psm (Surv(OS, Death) ~ Age + Gender + HBsAg + Cirrhosis + ALT + AST + AFP + Tumorsize + Tumordifferentiation + Vascularinvasion + Tumormultiplicity  + Capsulation  + TNM  + BCLC  + CXCL17T  + CXCL17P  + CXCL17N, data = as.data.frame(hepatoCellular), dist= 'weibull' , y=TRUE)

lnorm_reg_os_psm <- psm (Surv(OS, Death) ~ Age + Gender + HBsAg + Cirrhosis + ALT + AST + AFP + Tumorsize + Tumordifferentiation + Vascularinvasion + Tumormultiplicity  + Capsulation  + TNM  + BCLC  + CXCL17T  + CXCL17P  + CXCL17N, data = as.data.frame(hepatoCellular), dist= 'lognormal' , y=TRUE)

llog_reg_os_psm <- psm (Surv(OS, Death) ~ Age + Gender + HBsAg + Cirrhosis + ALT + AST + AFP + Tumorsize + Tumordifferentiation + Vascularinvasion + Tumormultiplicity  + Capsulation  + TNM  + BCLC  + CXCL17T  + CXCL17P  + CXCL17N, data = as.data.frame(hepatoCellular), dist= 'loglogistic' , y=TRUE)


exp_reg_rfs_psm <- psm (Surv(RFS, Recurrence) ~ Age + Gender + HBsAg + Cirrhosis + ALT + AST + AFP + Tumorsize + Tumordifferentiation + Vascularinvasion + Tumormultiplicity  + Capsulation  + TNM  + BCLC  + CXCL17T  + CXCL17P  + CXCL17N, data = as.data.frame(hepatoCellular), dist= 'exponential' , y=TRUE)

weib_reg_rfs_psm <- psm (Surv(RFS, Recurrence) ~ Age + Gender + HBsAg + Cirrhosis + ALT + AST + AFP + Tumorsize + Tumordifferentiation + Vascularinvasion + Tumormultiplicity  + Capsulation  + TNM  + BCLC  + CXCL17T  + CXCL17P  + CXCL17N, data = as.data.frame(hepatoCellular), dist= 'weibull' , y=TRUE)

lnorm_reg_rfs_psm <- psm (Surv(RFS, Recurrence) ~ Age + Gender + HBsAg + Cirrhosis + ALT + AST + AFP + Tumorsize + Tumordifferentiation + Vascularinvasion + Tumormultiplicity  + Capsulation  + TNM  + BCLC  + CXCL17T  + CXCL17P  + CXCL17N, data = hepatoCellular, dist= 'lognormal' , y=TRUE)

lnorm_reg_rfs_psm <- psm (Surv(RFS, Recurrence) ~ Age + Gender + HBsAg + Cirrhosis + ALT + AST + AFP + Tumorsize + Tumordifferentiation + Vascularinvasion + Tumormultiplicity  + Capsulation  + TNM  + BCLC  + CXCL17T  + CXCL17P  + CXCL17N, data = as.data.frame(hepatoCellular), dist= 'lognormal' , y=TRUE)

llog_reg_rfs_psm <- psm (Surv(RFS, Recurrence) ~ Age + Gender + HBsAg + Cirrhosis + ALT + AST + AFP + Tumorsize + Tumordifferentiation + Vascularinvasion + Tumormultiplicity  + Capsulation  + TNM  + BCLC  + CXCL17T  + CXCL17P  + CXCL17N, data = as.data.frame(hepatoCellular), dist= 'loglogistic' , y=TRUE)


```

<br/>
With the *rms* package, we can easily repeat the previous residual plot and, in addition, group the residuals according to predictors to check the fit in more detail. 
<br/>

```{r,message = FALSE,warning=FALSE}
resid_os <- resid(lnorm_reg_os_psm)
resid_rfs <- resid(lnorm_reg_rfs_psm)

par(mfrow = c(1, 2))
survplot (resid_os,main = 'Overall Survival')
survplot (resid_rfs,main = 'Recurrence-free Survival')

survplot (resid_os, hepatoCellular$Age,label.curve =TRUE,main = 'OS (Age)')
survplot (resid_rfs, hepatoCellular$Age,label.curve =TRUE,main = 'RFS (Age)')

survplot (resid_os, hepatoCellular$Gender,label.curve =TRUE,main = 'OS (Gender)')
survplot (resid_rfs, hepatoCellular$Gender,label.curve =TRUE,main = 'RFS (Gender)')

survplot (resid_os, hepatoCellular$Tumorsize,label.curve =TRUE,main = 'OS (Tumorsize)')
survplot (resid_rfs, hepatoCellular$Tumorsize,label.curve =TRUE,main = 'RFS (Tumorsize)')

survplot (resid_os, hepatoCellular$Tumordifferentiation,label.curve =TRUE,main = 'OS (Tumordifferentiation)')
survplot (resid_rfs, hepatoCellular$Tumordifferentiation,label.curve =TRUE,main = 'RFS (Tumordifferentiation)')

survplot (resid_os, hepatoCellular$BCLC,label.curve =TRUE,main = 'OS (BCLC)')
survplot (resid_rfs, hepatoCellular$BCLC,label.curve =TRUE,main = 'RFS (BCLC)')

survplot (resid_os, hepatoCellular$CXCL17T,label.curve =TRUE,main = 'OS (CXCL17T)')
survplot (resid_rfs, hepatoCellular$CXCL17T,label.curve =TRUE,main = 'RFS (CXCL17T)')

survplot (resid_os, hepatoCellular$CXCL17P,label.curve =TRUE,main = 'OS (CXCL17P)')
survplot (resid_rfs, hepatoCellular$CXCL17P,label.curve =TRUE,main = 'RFS (CXCL17P)')

survplot (resid_os, hepatoCellular$CXCL17P,label.curve =TRUE,main = 'OS (CXCL17N)')
survplot (resid_rfs, hepatoCellular$CXCL17P,label.curve =TRUE,main = 'RFS (CXCL17N)')
```

<br/>
Next, we can also check the dfbetas residuals to assess the influence of individual observations on the fit.
<br/>

```{r,message=FALSE,warning=FALSE}
par(mfrow = c(1, 3))
plot(residuals(lnorm_reg_os_psm, type='dfbetas')[,14],ylab = 'dfbetas residuals',main = 'CXCL17T (OS)')
plot(residuals(lnorm_reg_os_psm, type='dfbetas')[,15],ylab = 'dfbetas residuals',main = 'CXCL17P (OS)')
plot(residuals(lnorm_reg_os_psm, type='dfbetas')[,16],ylab = 'dfbetas residuals',main = 'CXCL17N (OS)')

plot(residuals(lnorm_reg_rfs_psm, type='dfbetas')[,14],ylab = 'dfbetas residuals',main = 'CXCL17T (RFS)')
plot(residuals(lnorm_reg_rfs_psm, type='dfbetas')[,15],ylab = 'dfbetas residuals',main = 'CXCL17P (RFS)')
plot(residuals(lnorm_reg_rfs_psm, type='dfbetas')[,16],ylab = 'dfbetas residuals',main = 'CXCL17N (RFS)')
```

<br/>
One observation has a significant effect on the estimate of **CXCL17N** in the **OS** model. Let us check whether its exclusion would change our conclusions. 
<br/>

```{r,message = FALSE,warning=FALSE}
lnorm_reg_os_red <- survreg(Surv(OS, Death) ~ Age + Gender + HBsAg + Cirrhosis + ALT + AST + AFP + Tumorsize + Tumordifferentiation + Vascularinvasion + Tumormultiplicity  + Capsulation  + TNM  + BCLC  + CXCL17T  + CXCL17P  + CXCL17N, data = hepatoCellular[-77,],dist='lognormal')

Anova(lnorm_reg_os_red)[15:17,]
```

<br/>
**CXCL17N** is still clearly non-significant. Lastly, we will perform bootstrapped Wald tests.
<br/>


```{r,message=FALSE,warning=FALSE}
set.seed(123) # for reproducibility
nb <- 2500

coefmat_os <- matrix(NA,nb,18)
coefmat_rfs <- matrix(NA,nb,18)

wald_boot_os <- matrix(0,18,nb)
pwald_os <- numeric(18)

wald_boot_rfs <- matrix(0,18,nb)
pwald_rfs <- numeric(18)

for(i in 1:nb){
  
  hepatoCellular_new <-  hepatoCellular[sample(nrow(hepatoCellular) , rep=TRUE),]
  
  model_os_new <- survreg(Surv(OS, Death) ~ Age + Gender + HBsAg + Cirrhosis + ALT + AST + AFP + Tumorsize + Tumordifferentiation + Vascularinvasion + Tumormultiplicity  + Capsulation  + TNM  + BCLC  + CXCL17T  + CXCL17P  + CXCL17N, data = hepatoCellular_new,dist='lognormal')
  
  model_rfs_new <- survreg(Surv(RFS, Recurrence) ~ Age + Gender + HBsAg + Cirrhosis + ALT + AST + AFP + Tumorsize + Tumordifferentiation + Vascularinvasion + Tumormultiplicity  + Capsulation  + TNM  + BCLC  + CXCL17T  + CXCL17P  + CXCL17N, data = hepatoCellular_new,dist='lognormal')
  
  coefmat_os[i,] <- coefficients(model_os_new)
  coefmat_rfs[i,] <- coefficients(model_rfs_new)
  
  for (j in 1:18){
    
  # trycatch to skip numerical problems with inversions
  V <- vcov(model_os_new)[j,j]
  wald_boot_os[j,i] <- tryCatch((coefficients(model_os_new)[j]-coefficients(lnorm_reg_os)[j]) %*% solve(V) %*% (coefficients(model_os_new)[j]-coefficients(lnorm_reg_os)[j]), error = function(e) {NaN})
  
  V <- vcov(model_rfs_new)[j,j]
  wald_boot_rfs[j,i] <- tryCatch((coefficients(model_rfs_new)[j]-coefficients(lnorm_reg_rfs)[j]) %*% solve(V) %*% (coefficients(model_rfs_new)[j]-coefficients(lnorm_reg_rfs)[j]), error = function(e) {NaN})
  
  }
}

for (j in 1:18){
V <- vcov(lnorm_reg_os)[j,j]
wald <- coefficients(lnorm_reg_os)[j] %*% solve(V) %*% coefficients(lnorm_reg_os)[j]      
pwald_os[j] <- mean(wald_boot_os[j,] > as.numeric(wald),na.rm = TRUE) # p-value

V <- vcov(lnorm_reg_rfs)[j,j]
wald <- coefficients(lnorm_reg_os)[j] %*% solve(V) %*% coefficients(lnorm_reg_os)[j]      
pwald_rfs[j] <- mean(wald_boot_rfs[j,] > as.numeric(wald),na.rm = TRUE) # p-value

}

var_names <- c('Intercept','Age','Gender','HBsAg','Cirrhosis','ALT','AST','AFP','Tumorsize','Tumordifferentiation','Vascularinvasion','Tumormultiplicity','Capsulation','TNM','BCLC','CXCL17T','CXCL17P','CXCL17N')
names(pwald_os) <- var_names
names(pwald_rfs) <- var_names

pwald_os[16:18]
pwald_rfs[16:18]
```


<br/>
We obtained results similar to those of the likelihood ratio tests.
<br/>

###  Predictions and validations

<br/>
The *rms* package gives us easy ways to visualize the effect of the predictors.
<br/>

```{r,message = FALSE,warning=FALSE}
options(datadist="dd")
dd <- datadist(hepatoCellular)

par(mfrow = c(1, 2))
survplot(lnorm_reg_os_psm,Age = c(50,70),xlab = 'Months', ylab = 'Overall Survival Probability (Age)', adj.subtitle=FALSE)
survplot(lnorm_reg_rfs_psm,Age= c(50,70),xlab = 'Months', ylab = 'Recurrence-free Survival Probability (Age)',adj.subtitle=FALSE)

par(mfrow = c(1, 2))
survplot(lnorm_reg_os_psm,Gender,xlab = 'Months', ylab = 'Overall Survival Probability (Gender)', adj.subtitle=FALSE)
survplot(lnorm_reg_rfs_psm,Gender,xlab = 'Months', ylab = 'Recurrence-free Survival Probability (Gender)',adj.subtitle=FALSE)

survplot(lnorm_reg_os_psm,Tumorsize,xlab = 'Months', ylab = 'Overall Survival Probability (Tumorsize)', adj.subtitle=FALSE)
survplot(lnorm_reg_rfs_psm,Tumorsize,xlab = 'Months', ylab = 'Recurrence-free Survival Probability (Tumorsize)',adj.subtitle=FALSE)

survplot(lnorm_reg_os_psm,Tumordifferentiation,xlab = 'Months', ylab = 'Overall Survival Probability (Tumordiff)', adj.subtitle=FALSE)
survplot(lnorm_reg_rfs_psm,Tumordifferentiation,xlab = 'Months', ylab = 'Recurrence-free Survival Probability (Tumordiff)',adj.subtitle=FALSE)

survplot(lnorm_reg_os_psm,BCLC,xlab = 'Months', ylab = 'Overall Survival Probability (BCLC)', adj.subtitle=FALSE)
survplot(lnorm_reg_rfs_psm,BCLC,xlab = 'Months', ylab = 'Recurrence-free Survival Probability (BCLC)',adj.subtitle=FALSE)

survplot(lnorm_reg_os_psm,CXCL17T = c(0,500,1000),xlab = 'Months', ylab = 'Overall Survival Probability (CXCL17T)', adj.subtitle=FALSE)
survplot(lnorm_reg_rfs_psm,CXCL17T = c(0,500,1000),xlab = 'Months', ylab = 'Recurrence-free Survival Probability (CXCL17T)',adj.subtitle=FALSE)

survplot(lnorm_reg_os_psm,CXCL17P = c(0,500,1000),xlab = 'Months', ylab = 'Overall Survival Probability (CXCL17P)', adj.subtitle=FALSE)
survplot(lnorm_reg_rfs_psm,CXCL17P = c(0,500,1000),xlab = 'Months', ylab = 'Recurrence-free Survival Probability (CXCL17P)',adj.subtitle=FALSE)

survplot(lnorm_reg_os_psm,CXCL17N = c(0,500,1000),xlab = 'Months', ylab = 'Overall Survival Probability (CXCL17N)', adj.subtitle=FALSE)
survplot(lnorm_reg_rfs_psm,CXCL17N = c(0,500,1000),xlab = 'Months', ylab = 'Recurrence-free Survival Probability (CXCL17N)',adj.subtitle=FALSE)
```

<br/>
All that remains is model validation. Again, the discrimination metrics we will consider in this project are concordance and the Brier score.
<br/>

```{r,message = FALSE,warning=FALSE}
conc_atm <- cbind(c(concordance(exp_reg_os_psm)$concordance,
concordance(weib_reg_os_psm)$concordance,
concordance(lnorm_reg_os_psm)$concordance,
concordance(llog_reg_os_psm)$concordance),
c(concordance(exp_reg_rfs_psm)$concordance,
concordance(weib_reg_rfs_psm)$concordance,
concordance(lnorm_reg_rfs_psm)$concordance,
concordance(llog_reg_rfs_psm)$concordance))

colnames(conc_atm) <- c('OS','RFS')
rownames(conc_atm) <- c('exp','weib','lognormal','loglogist')
conc_atm
```

```{r,message = FALSE,warning=FALSE}
brier_atm <- cbind(c(as.numeric(crps(pec(exp_reg_os_psm,cens.model = 'marginal'),start = 0,times = 80))[2],
as.numeric(crps(pec(weib_reg_os_psm,cens.model = 'marginal')))[2],
as.numeric(crps(pec(lnorm_reg_os_psm,cens.model = 'marginal')))[2],
as.numeric(crps(pec(llog_reg_os_psm,cens.model = 'marginal')))[2]),
c(as.numeric(crps(pec(exp_reg_rfs_psm,cens.model = 'marginal')))[2],
as.numeric(crps(pec(weib_reg_rfs_psm,cens.model = 'marginal')))[2],
as.numeric(crps(pec(lnorm_reg_rfs_psm,cens.model = 'marginal')))[2],
as.numeric(crps(pec(llog_reg_rfs_psm,cens.model = 'marginal')))[2]))

colnames(brier_atm) <- c('OS','RFS')
rownames(brier_atm) <- c('exp','weib','lognormal','loglogist')
brier_atm
```

<br/>
As far as calibration is concerned, we cannot use the approach for the proportional hazard models. Instead, we will use the approach described in https://www.rdocumentation.org/packages/rms/versions/8.0-0/topics/val.surv
<br/>

```{r,message = FALSE,warning=FALSE}
par(mfrow = c(1, 1))
plot(val.surv(lnorm_reg_rfs_psm))
```

<br/>
It will be more illustrative to remake this plot manually. First, we obtain the predicted survival probabilities $S(T_{obs}\mid X)$ from the model, where $T_{obs}$ are the observed survival times. Then, we will compute the Kepler-Meier estimator of $1- S(T_{obs}\mid X)$, since $T_{obs}$ are censored. Provided that the model is well-calibrated, this survival estimator should be approximately a -45° line from one to zero (*val.surv* plot is just 1 - the KM estimator). We can then evaluate the calibration via a linear fit. 
<br/>

```{r,message = FALSE,warning=FALSE}
# compute surv. probabilities
surv_probabilities <- diag(predictSurvProb(lnorm_reg_rfs_psm,newdata = as.data.frame(hepatoCellular),times = hepatoCellular$RFS))

# KM estimator of 1-S with Recurrence censoring
km_surv_probabilities <- survfit(Surv(1-surv_probabilities, Recurrence) ~ 1, data = hepatoCellular)
plot(km_surv_probabilities)
abline(1,-1)

# the val.surv plot
plot(km_surv_probabilities$time, 1 - km_surv_probabilities$surv,xlim = c(0,1),ylim = c(0,1),xlab = 'Predicted P(T <= observed T)', ylab = 'observed fractions (KM estimator)',main = 'RFS')
abline(0,1)


lm(1-km_surv_probabilities$surv~km_surv_probabilities$time)
```

<br/>
The model is well-calibrated on the training data. Again, the result could be quite different on the test data.
<br/>

```{r,message = FALSE,warning=FALSE}
set.seed(113)
d <- createFolds(seq(1,dim(hepatoCellular)[1],1), k = 10)
index <- unlist(d[1])
train_set <- hepatoCellular[-index,]
test_set <- hepatoCellular[index,]

lnorm_reg_rfs_psm_partial <- psm (Surv(RFS, Recurrence) ~ Age + Gender + HBsAg + Cirrhosis + ALT + AST + AFP + Tumorsize + Tumordifferentiation + Vascularinvasion + Tumormultiplicity  + Capsulation  + TNM  + BCLC  + CXCL17T  + CXCL17P  + CXCL17N, data = as.data.frame(train_set), dist= 'lognormal' , y=TRUE)


# compute surv. probabilities
surv_probabilities <- diag(predictSurvProb(lnorm_reg_rfs_psm_partial,newdata = as.data.frame(test_set),times = test_set$RFS))

# KM estimator of 1-S with Recurrence censoring
km_surv_probabilities <- survfit(Surv(1-surv_probabilities, Recurrence) ~ 1, data = test_set)

plot(km_surv_probabilities$time, 1 - km_surv_probabilities$surv,xlim = c(0,1),ylim = c(0,1),xlab = 'Predicted P(T <= observed T)', ylab = 'observed fractions (KM estimator)',main = 'RFS')
abline(0,1)

lm(1-km_surv_probabilities$surv~km_surv_probabilities$time)
```

<br/>
All that remains is a cross-validation of all AFT models.
<br/>

```{r,message = FALSE,warning=FALSE}
library(caret)

## Number of repetitions and folds
rep <- 100
folds <- 10

set.seed(123) # for reproducibility

k <- 1

concordance_cv <- matrix(NA,folds*rep,8)
brier_cv <- matrix(NA,folds*rep,8)
gamma0_cv <- matrix(NA,folds*rep,8)
gamma1_cv <- matrix(NA,folds*rep,8)


for(j in 1:rep){
  
  d <- createFolds(seq(1,dim(hepatoCellular)[1],1), k = 10)
  
  for(i in 1:folds){

    index <- unlist(d[i])
    train_set <- as.data.frame(hepatoCellular[-index,])
    test_set <- as.data.frame(hepatoCellular[index,])

    exp_reg_os_psm_new <- psm (Surv(OS, Death) ~ Age + Gender + HBsAg + Cirrhosis + ALT + AST + AFP + Tumorsize + Tumordifferentiation + Vascularinvasion + Tumormultiplicity  + Capsulation  + TNM  + BCLC  + CXCL17T  + CXCL17P  + CXCL17N, train_set, dist= 'exponential' , y=TRUE)
    
    weib_reg_os_psm_new <- psm (Surv(OS, Death) ~ Age + Gender + HBsAg + Cirrhosis + ALT + AST + AFP + Tumorsize + Tumordifferentiation + Vascularinvasion + Tumormultiplicity  + Capsulation  + TNM  + BCLC  + CXCL17T  + CXCL17P  + CXCL17N, train_set, dist= 'weibull' , y=TRUE)
    
    lnorm_reg_os_psm_new <- psm (Surv(OS, Death) ~ Age + Gender + HBsAg + Cirrhosis + ALT + AST + AFP + Tumorsize + Tumordifferentiation + Vascularinvasion + Tumormultiplicity  + Capsulation  + TNM  + BCLC  + CXCL17T  + CXCL17P  + CXCL17N, data = train_set, dist= 'lognormal' , y=TRUE)
    
    llog_reg_os_psm_new <- psm (Surv(OS, Death) ~ Age + Gender + HBsAg + Cirrhosis + ALT + AST + AFP + Tumorsize + Tumordifferentiation + Vascularinvasion + Tumormultiplicity  + Capsulation  + TNM  + BCLC  + CXCL17T  + CXCL17P  + CXCL17N, data = train_set, dist= 'loglogistic' , y=TRUE)
    
    exp_reg_rfs_psm_new <- psm (Surv(RFS, Recurrence) ~ Age + Gender + HBsAg + Cirrhosis + ALT + AST + AFP + Tumorsize + Tumordifferentiation + Vascularinvasion + Tumormultiplicity  + Capsulation  + TNM  + BCLC  + CXCL17T  + CXCL17P  + CXCL17N, data = train_set, dist= 'exponential' , y=TRUE)
    
    weib_reg_rfs_psm_new <- psm (Surv(RFS, Recurrence) ~ Age + Gender + HBsAg + Cirrhosis + ALT + AST + AFP + Tumorsize + Tumordifferentiation + Vascularinvasion + Tumormultiplicity  + Capsulation  + TNM  + BCLC  + CXCL17T  + CXCL17P  + CXCL17N, data = train_set, dist= 'weibull' , y=TRUE)
    
    lnorm_reg_rfs_psm_new <- psm (Surv(RFS, Recurrence) ~ Age + Gender + HBsAg + Cirrhosis + ALT + AST + AFP + Tumorsize + Tumordifferentiation + Vascularinvasion + Tumormultiplicity  + Capsulation  + TNM  + BCLC  + CXCL17T  + CXCL17P  + CXCL17N, data = train_set, dist= 'lognormal' , y=TRUE)
    
    lnorm_reg_rfs_psm_new <- psm (Surv(RFS, Recurrence) ~ Age + Gender + HBsAg + Cirrhosis + ALT + AST + AFP + Tumorsize + Tumordifferentiation + Vascularinvasion + Tumormultiplicity  + Capsulation  + TNM  + BCLC  + CXCL17T  + CXCL17P  + CXCL17N, data = train_set, dist= 'lognormal' , y=TRUE)
    
    llog_reg_rfs_psm_new <- psm (Surv(RFS, Recurrence) ~ Age + Gender + HBsAg + Cirrhosis + ALT + AST + AFP + Tumorsize + Tumordifferentiation + Vascularinvasion + Tumormultiplicity  + Capsulation  + TNM  + BCLC  + CXCL17T  + CXCL17P  + CXCL17N, data = train_set, dist= 'loglogistic' , y=TRUE)

    # concordance
    concordance_cv[k,1] <- concordance(exp_reg_os_psm_new,newdata = test_set)$concordance
    concordance_cv[k,2] <- concordance(weib_reg_os_psm_new,newdata = test_set)$concordance
    concordance_cv[k,3] <- concordance(lnorm_reg_os_psm_new,newdata = test_set)$concordance
    concordance_cv[k,4] <- concordance(llog_reg_os_psm_new,newdata = test_set)$concordance
    concordance_cv[k,5] <- concordance(exp_reg_rfs_psm_new,newdata = test_set)$concordance
    concordance_cv[k,6] <- concordance(weib_reg_rfs_psm_new,newdata = test_set)$concordance
    concordance_cv[k,7] <- concordance(lnorm_reg_rfs_psm_new,newdata = test_set)$concordance
    concordance_cv[k,8] <- concordance(llog_reg_rfs_psm_new,newdata = test_set)$concordance
    
    
    brier_cv[k,1] <- as.numeric(crps(pec(exp_reg_os_psm_new,newdata = test_set,cens.model = 'marginal')))[2]
    brier_cv[k,2] <- as.numeric(crps(pec(weib_reg_os_psm_new,data = test_set,cens.model = 'marginal')))[2]
    brier_cv[k,3] <- as.numeric(crps(pec(lnorm_reg_os_psm_new,data = test_set,cens.model = 'marginal')))[2]
    brier_cv[k,4] <- as.numeric(crps(pec(llog_reg_os_psm_new,data = test_set,cens.model = 'marginal')))[2]
    brier_cv[k,5] <- as.numeric(crps(pec(exp_reg_rfs_psm_new,data = test_set,cens.model = 'marginal')))[2]
    brier_cv[k,6] <- as.numeric(crps(pec(weib_reg_rfs_psm_new,data = test_set,cens.model = 'marginal')))[2]
    brier_cv[k,7] <- as.numeric(crps(pec(lnorm_reg_rfs_psm_new,data = test_set,cens.model = 'marginal')))[2]
    brier_cv[k,8] <- as.numeric(crps(pec(llog_reg_rfs_psm_new,data = test_set,cens.model = 'marginal')))[2]

    
    # exp_reg_os_psm_new
    surv_probabilities <- diag(predictSurvProb(exp_reg_os_psm_new,newdata = as.data.frame(test_set),times = test_set$OS))
    km_surv_probabilities <- survfit(Surv(1-surv_probabilities, Death) ~ 1, data = test_set)
    gammas <- coefficients(lm(1-km_surv_probabilities$surv~km_surv_probabilities$time))
    gamma0_cv[k,1] <- gammas[1]
    gamma1_cv[k,1] <- gammas[2]
    
    # weib_reg_os_psm_new
    surv_probabilities <- diag(predictSurvProb(weib_reg_os_psm_new,newdata = as.data.frame(test_set),times = test_set$OS))
    km_surv_probabilities <- survfit(Surv(1-surv_probabilities, Death) ~ 1, data = test_set)
    gammas <- coefficients(lm(1-km_surv_probabilities$surv~km_surv_probabilities$time))
    gamma0_cv[k,2] <- gammas[1]
    gamma1_cv[k,2] <- gammas[2]
    
    # lnorm_reg_os_psm_new
    surv_probabilities <- diag(predictSurvProb(lnorm_reg_os_psm_new,newdata = as.data.frame(test_set),times = test_set$OS))
    km_surv_probabilities <- survfit(Surv(1-surv_probabilities, Death) ~ 1, data = test_set)
    gammas <- coefficients(lm(1-km_surv_probabilities$surv~km_surv_probabilities$time))
    gamma0_cv[k,3] <- gammas[1]
    gamma1_cv[k,3] <- gammas[2]
    
    # llog_reg_os_psm_new
    surv_probabilities <- diag(predictSurvProb(llog_reg_os_psm_new,newdata = as.data.frame(test_set),times = test_set$OS))
    km_surv_probabilities <- survfit(Surv(1-surv_probabilities, Death) ~ 1, data = test_set)
    gammas <- coefficients(lm(1-km_surv_probabilities$surv~km_surv_probabilities$time))
    gamma0_cv[k,4] <- gammas[1]
    gamma1_cv[k,4] <- gammas[2]
    
    # exp_reg_rfs_psm_new
    surv_probabilities <- diag(predictSurvProb(exp_reg_rfs_psm_new,newdata = as.data.frame(test_set),times = test_set$RFS))
    km_surv_probabilities <- survfit(Surv(1-surv_probabilities, Recurrence) ~ 1, data = test_set)
    gammas <- coefficients(lm(1-km_surv_probabilities$surv~km_surv_probabilities$time))
    gamma0_cv[k,5] <- gammas[1]
    gamma1_cv[k,5] <- gammas[2]
    
    # weib_reg_rfs_psm_new
    surv_probabilities <- diag(predictSurvProb(weib_reg_rfs_psm_new,newdata = as.data.frame(test_set),times = test_set$RFS))
    km_surv_probabilities <- survfit(Surv(1-surv_probabilities, Recurrence) ~ 1, data = test_set)
    gammas <- coefficients(lm(1-km_surv_probabilities$surv~km_surv_probabilities$time))
    gamma0_cv[k,6] <- gammas[1]
    gamma1_cv[k,6] <- gammas[2]
    
    # lnorm_reg_rfs_psm_new
    surv_probabilities <- diag(predictSurvProb(lnorm_reg_rfs_psm_new,newdata = as.data.frame(test_set),times = test_set$RFS))
    km_surv_probabilities <- survfit(Surv(1-surv_probabilities, Recurrence) ~ 1, data = test_set)
    gammas <- coefficients(lm(1-km_surv_probabilities$surv~km_surv_probabilities$time))
    gamma0_cv[k,7] <- gammas[1]
    gamma1_cv[k,7] <- gammas[2]
    
    # llog_reg_rfs_psm_new
    surv_probabilities <- diag(predictSurvProb(llog_reg_rfs_psm_new,newdata = as.data.frame(test_set),times = test_set$RFS))
    km_surv_probabilities <- survfit(Surv(1-surv_probabilities, Recurrence) ~ 1, data = test_set)
    gammas <- coefficients(lm(1-km_surv_probabilities$surv~km_surv_probabilities$time))
    gamma0_cv[k,8] <- gammas[1]
    gamma1_cv[k,8] <- gammas[2]
    
    k <- k + 1
    
  }
}

cv_res2 <- cbind(apply(concordance_cv,2,mean,na.rm = TRUE),
apply(brier_cv,2,mean,na.rm = TRUE), 
apply(gamma0_cv,2,mean,na.rm = TRUE),       
apply(gamma1_cv,2,mean,na.rm = TRUE))

colnames(cv_res2) <- c('Concordance','Brier','Intercept','Slope')
rownames(cv_res2) <- c('exp(OS)','weib(OS)','lognorm(OS)','loglogist(OS)','exp(RFS)','weib(RFS)','lognorm(RFS)','loglogist(RFS)')
cv_res2
```

<br/>
Log-normal models appear to be the best overall. It also seems that the lognormal models perform a bit better in terms of concordance than the Cox models, but are worse in terms of the Brier score.
<br/>

### Conclusions

<br/>
In this project, we have performed an analysis of the Hepatocellular dataset. We have shown that the biomarker **CXCL17P** is associated with the overall survival and the recurrence-free survival using the Cox proportional hazards models and the lognormal AFT models, both of which provided similar results (P-value < 0.05 in all considered likelihood ratio tests, Wald tests, and bootstrapped Wald tests). The biomarker **CXCL17T** is associated with the recurrence-free survival (P-value < 0.05 in all considered likelihood ratio tests, Wald tests, and bootstrapped Wald tests), but it was not significant in some tests for the overall survival models. The biomarker **CXCL17N** was not significant in any of the considered models. We have also performed model validation of all considered models via cross-validation to assess the generalizability of the results to new data. 

With that conclusion, we end Part One of this circle dedicated to the survival analysis. In Part Two, we will have a look at the survival models with multiple outcomes / competing risks. 
<br/>


###  References

* [1] L. Li et al. CXCL17 expression predicts poor prognosis and correlates with adverse immune infiltration in hepatocellular carcinoma. PloS one 9.10 (2014): e110064.

* [2] D. F. Moore. Applied survival analysis using R. Vol. 473. Cham: Springer, 2016.

* [3] P. C. Austin, D. S. Lee, and J. P. Fine. Introduction to the analysis of survival data in the presence of competing risks. Circulation 133.6 (2016): 601-609.

* [4] F.Harrell. Regression modeling strategies. New York: Springer-Verlag, 2001.

* [5] T. M. Therneau and P. M. Grambsch. Modeling survival data: extending the Cox model. New York, NY: Springer New York, 2000

* [6] F. E. Harrell, K. L. Lee, and D. B. Mark. Multivariable prognostic models: issues in developing models, evaluating assumptions and adequacy, and measuring and reducing errors. Statistics in medicine 15.4 (1996): 361-387.

* [7] N. Hartman et al. Pitfalls of the concordance index for survival outcomes. Statistics in medicine 42.13 (2023): 2179-2190.

* [8] E. Graf et al. Assessment and comparison of prognostic classification schemes for survival data. Statistics in medicine 18.17‐18 (1999): 2529-2545.

* [9] C. S. Crowson, E. J. Atkinson, and T. M. Therneau. Assessing calibration of prognostic risk scores. Statistical methods in medical research 25.4 (2016): 1692-1706.
